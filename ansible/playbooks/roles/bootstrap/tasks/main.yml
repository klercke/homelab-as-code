---
# Main tasks for the bootstrap role

# Change hostname
- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
    use: "systemd"

# Update packages
- name: Update all packages
  ansible.builtin.dnf:
    name: "*"
    state: latest

- name: Install important packages
  ansible.builtin.dnf:
    name: "dnf-utils"
    state: present

# Install EPEL repository
- name: Ensure EPEL repository is installed
  ansible.builtin.dnf:
    name: epel-release
    state: present

# Create the Ansible user
- name: Create the ansible user
  ansible.builtin.user:
    name: "ansible"
    shell: /bin/bash
    state: present
    groups: wheel
    append: true

- name: Create .ssh directory for ansible user
  ansible.builtin.file:
    path: "/home/ansible/.ssh"
    state: directory
    owner: "ansible"
    group: "ansible"
    mode: "0700"

- name: Add authorized SSH key for ansible user
  ansible.builtin.copy:
    src: "{{ ssh_key_path }}"
    dest: "/home/ansible/.ssh/authorized_keys"
    owner: "ansible"
    group: "ansible"
    mode: "0600"

- name: Allow ansible user to sudo with no password
  ansible.builtin.copy:
    src: "{{ role_path }}/files/sudoers_ansible"
    dest: "/etc/sudoers.d"
    owner: "root"
    group: "root"
    mode: "0440"

# Harden SSH configuration
- name: Disable root login
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
  notify:
    - Restart sshd

- name: Allow only ansible user to SSH
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?AllowUsers'
    line: 'AllowUsers ansible'
    state: present
  notify:
    - Restart sshd

- name: Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?PasswordAuthentication'
    line: 'PasswordAuthentication no'
    state: present
  notify:
    - Restart sshd

- name: Enable SSH protocol 2
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?Protocol'
    line: 'Protocol 2'
    state: present
  notify:
    - Restart sshd

- name: Disable X11 forwarding
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^#?X11Forwarding'
    line: 'X11Forwarding no'
    state: present
  notify:
    - Restart sshd

# Enable automatic updates
- name: Install dnf-automatic
  ansible.builtin.dnf:
    name: dnf-automatic
    state: present

- name: Enable and start automatic updates
  ansible.builtin.systemd:
    name: dnf-automatic.timer
    enabled: true
    state: started

# Install and configure fail2ban
- name: Install fail2ban
  ansible.builtin.dnf:
    name: fail2ban
    state: present

- name: Resolve IP address from hostname
  ansible.builtin.set_fact:
    dynamic_ip: "{{ lookup('dig', 'ptxe.duckdns.org') }}"

- name: Deploy Fail2Ban configuration with dynamic IP
  ansible.builtin.template:
    src: fail2ban.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify:
    - Restart fail2ban

- name: Ensure fail2ban service is enabled and started
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
  notify:
    - Restart fail2ban

# Configure the firewall
- name: Ensure firewalld is installed
  ansible.builtin.dnf:
    name: firewalld
    state: present

- name: Ensure firewalld is enabled and running
  ansible.builtin.systemd:
    name: firewalld
    enabled: true
    state: started

- name: Open ports in the firewall
  ansible.builtin.firewalld:
    port: "{{ item.port }}/{{ item.protocol }}"
    permanent: true
    state: enabled
  with_items: "{{ firewall_allowed_ports }}"
  notify:
    - Reload firewalld

